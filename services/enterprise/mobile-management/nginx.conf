events {
    worker_connections 1024;
}

http {
    upstream ios_management {
        server ios-management:3011 max_fails=3 fail_timeout=30s;
    }

    upstream android_enterprise {
        server android-enterprise:3012 max_fails=3 fail_timeout=30s;
    }

    upstream mobile_app_management {
        server mobile-app-management:3013 max_fails=3 fail_timeout=30s;
    }

    upstream mobile_threat_defense {
        server mobile-threat-defense:3014 max_fails=3 fail_timeout=30s;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=mobile_api:10m rate=100r/m;
    limit_req_zone $binary_remote_addr zone=mobile_upload:10m rate=10r/m;
    limit_req_zone $binary_remote_addr zone=mobile_threat:10m rate=200r/m;

    # Security headers
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    # Logging
    log_format mobile_access '$remote_addr - $remote_user [$time_local] "$request" '
                            '$status $body_bytes_sent "$http_referer" '
                            '"$http_user_agent" "$http_x_forwarded_for" '
                            'rt=$request_time uct="$upstream_connect_time" '
                            'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/mobile_access.log mobile_access;
    error_log /var/log/nginx/mobile_error.log warn;

    server {
        listen 80;
        server_name localhost;

        # Global health check
        location /health {
            access_log off;
            return 200 '{"status":"healthy","service":"mobile-management-proxy","timestamp":"$time_iso8601"}';
            add_header Content-Type application/json;
        }

        # iOS Management Service
        location /api/mobile/ios/ {
            limit_req zone=mobile_api burst=20 nodelay;
            
            proxy_pass http://ios_management/api/ios/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # iOS WebSocket
        location /ws/ios {
            proxy_pass http://ios_management;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Android Enterprise Service
        location /api/mobile/android/ {
            limit_req zone=mobile_api burst=20 nodelay;
            
            proxy_pass http://android_enterprise/api/android/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Android WebSocket
        location /ws/android {
            proxy_pass http://android_enterprise;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Mobile App Management Service
        location /api/mobile/mam/ {
            # Special rate limiting for uploads
            location ~* /api/mobile/mam/apps.*$ {
                limit_req zone=mobile_upload burst=5 nodelay;
                client_max_body_size 500M;
                proxy_request_buffering off;
                
                proxy_pass http://mobile_app_management/api/mam/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Request-ID $request_id;
                
                # Extended timeouts for uploads
                proxy_connect_timeout 300s;
                proxy_send_timeout 300s;
                proxy_read_timeout 300s;
            }
            
            limit_req zone=mobile_api burst=20 nodelay;
            
            proxy_pass http://mobile_app_management/api/mam/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # MAM WebSocket
        location /ws/mam {
            proxy_pass http://mobile_app_management;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Mobile Threat Defense Service
        location /api/mobile/mtd/ {
            limit_req zone=mobile_threat burst=50 nodelay;
            
            proxy_pass http://mobile_threat_defense/api/mtd/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # MTD WebSocket
        location /ws/mtd {
            proxy_pass http://mobile_threat_defense;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Service health checks
        location /health/ios {
            access_log off;
            proxy_pass http://ios_management/health;
        }

        location /health/android {
            access_log off;
            proxy_pass http://android_enterprise/health;
        }

        location /health/mam {
            access_log off;
            proxy_pass http://mobile_app_management/health;
        }

        location /health/mtd {
            access_log off;
            proxy_pass http://mobile_threat_defense/health;
        }

        # API documentation endpoint
        location /api/mobile/docs {
            return 200 '{
                "services": {
                    "ios_management": {
                        "name": "iOS Management Service",
                        "endpoint": "/api/mobile/ios",
                        "websocket": "/ws/ios",
                        "health": "/health/ios",
                        "version": "1.0.0"
                    },
                    "android_enterprise": {
                        "name": "Android Enterprise Service",
                        "endpoint": "/api/mobile/android",
                        "websocket": "/ws/android",
                        "health": "/health/android",
                        "version": "1.0.0"
                    },
                    "mobile_app_management": {
                        "name": "Mobile App Management Service",
                        "endpoint": "/api/mobile/mam",
                        "websocket": "/ws/mam",
                        "health": "/health/mam",
                        "version": "1.0.0"
                    },
                    "mobile_threat_defense": {
                        "name": "Mobile Threat Defense Service",
                        "endpoint": "/api/mobile/mtd",
                        "websocket": "/ws/mtd",
                        "health": "/health/mtd",
                        "version": "1.0.0"
                    }
                }
            }';
            add_header Content-Type application/json;
        }

        # Default fallback
        location / {
            return 404 '{"error":"Endpoint not found","available_endpoints":["/api/mobile/ios","/api/mobile/android","/api/mobile/mam","/api/mobile/mtd"]}';
            add_header Content-Type application/json;
        }
    }
}